<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ordenamento Territorial – Domicílios/Regiões</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{--bg:#fff;--panel:#f5f7fb;--text:#0b1020;--muted:#5b6b82;--border:#e9eef7;}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
    .app{display:grid;grid-template-rows:auto 1fr;height:100%}
    header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;padding:10px 14px;background:var(--panel);box-shadow:0 2px 12px rgba(0,0,0,.08);position:sticky;top:0;z-index:1000}
    header h1{font-size:18px;margin:0}
    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;font-size:14px;color:var(--muted)}
    .badge{display:flex;gap:8px;align-items:center;background:#eef2f9;padding:6px 10px;border-radius:12px}
    select{padding:6px 10px;border:1px solid #dbe3f0;border-radius:8px;background:#fff;color:#0b1020}
    #map{height:100%}
    .legend{position:absolute;right:10px;bottom:10px;background:#fff;padding:10px 12px;border:1px solid var(--border);border-radius:10px;z-index:600;max-width:300px}
    .legend h4{margin:0 0 6px;font-size:13px}
    .legend .row{display:flex;align-items:center;gap:8px;margin:4px 0;font-size:12px}
    .sw{width:14px;height:14px;border-radius:3px;border:1px solid #cbd5e1}
    .busy{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.75);color:#fff;padding:8px 12px;border-radius:8px;display:none;z-index:700}
    .leaflet-popup-content-wrapper{border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.15)}
    .leaflet-popup-content{margin:12px 16px}
    table.min{border-collapse:collapse;width:100%;font-size:12px}
    table.min td{padding:3px 6px;border-bottom:1px solid #eee;vertical-align:top}
    .hint{margin-left:auto;color:#6b7280;font-size:12px}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Domicílios</h1>
      <div class="controls">

<label class="badge">Limites por regiões:
  <select id="selKmlRegion">
    <option value="__ALL__">Todos</option>
    <option value="barcarena">Barcarena (Sede)</option>
    <option value="murucupi">Murucupi</option>
    <option value="estradas">Estradas</option>
    <option value="ilhas">Ilhas</option>
    <option value="viladoconde">Vila do Conde</option>
  </select>
</label>

        <label class="badge">Região:
          <select id="selDistrito"></select>
        </label>
        <label class="badge">Bairro:
          <select id="selBairro"></select>
        </label>

        <label class="badge">Tipo de domicílios:
          <select id="selTipo">
            <option value="">— Todos —</option>
            <option value="1">Área urbana de alta densidade de edificações de cidade ou vila</option>
            <option value="2">Área urbana de baixa densidade de edificações de cidade ou vila</option>
            <option value="3">Núcleo urbano</option>
            <option value="5">Aglomerado rural - Povoado</option>
            <option value="6">Aglomerado rural - Núcleo rural</option>
            <option value="7">Aglomerado rural - Lugarejo</option>
            <option value="8">Área rural (exclusive aglomerados)</option>
          </select>
        </label>
        <span id="status" class="hint"></span>
      </div>
    </header>
    <div id="map"></div>
  </div>

  <div id="legend" class="legend" style="display:none">
    <h4>Legenda – Bairros</h4>
    <div id="legendItems"></div>
  </div>

  <div id="busy" class="busy">Carregando…</div>

  <script>
    /* ======= CONFIG ======= */
    const CSV_PATH = 'dados_setores.csv'; // ajuste se necessário
    const KML_BASE = 'distritos/kml/';                  // pasta dos KMLs (ex.: 'setores/')

    // ======= MAPA =======
    const map = L.map('map').setView([-1.45, -48.49], 11); // ajuste posição/zoom
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    const busy = on => document.getElementById('busy').style.display = on ? 'block' : 'none';

    // ======= UTIL =======
    const norm = s => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();
    function colorFor(key){
      // hash -> hsl
      let h=0; const s=65, l=52;
      const str = String(key);
      for (let i=0;i<str.length;i++) h = (h*31 + str.charCodeAt(i)) % 360;
      return `hsl(${h}, ${s}%, ${l}%)`;
    }
    function filenameFromSetor(cod){
      return `${cod}.kml`;
    }

    // ======= DADOS =======
    let setores = {};
    let porDistrito = {};

    function buildIndex(rows){
      setores = {};
      porDistrito = {};
      for (const r of rows){
        const cod = String(r.Cod_setor ?? r.cod_setor ?? r.COD_SETOR ?? r.setor ?? r.Setor ?? '').trim();
        if (!cod) continue;
        const distrito = String(r.Distrito ?? r.distrito ?? r.DISTRITO ?? '').trim();
        const bairro   = String(r.Bairro ?? r.bairro ?? r.BAIRRO ?? '').trim();

        const rec = Object.assign({}, r, {Cod_setor: cod, Distrito: distrito, Bairro: bairro});
        setores[cod] = rec;

        (porDistrito[distrito] ||= {bairros:new Set(), setores:[]});
        porDistrito[distrito].bairros.add(bairro || '(sem bairro)');
        porDistrito[distrito].setores.push(cod);
      }
      // popular selects
      const selDistrito = document.getElementById('selDistrito');
      selDistrito.innerHTML = '';
      const distritos = Object.keys(porDistrito).sort((a,b)=>a.localeCompare(b, 'pt-BR'));
      selDistrito.insertAdjacentHTML('beforeend', `<option value="__TODOS__">Todos</option>`);
      distritos.forEach(d=> selDistrito.insertAdjacentHTML('beforeend', `<option value="${d}">${d}</option>`));

      const selBairro = document.getElementById('selBairro');
      selDistrito.addEventListener('change', ()=>{
        fillBairros(selDistrito.value);
        refreshLayers();
      });
      selBairro.addEventListener('change', refreshLayers);

      fillBairros(''); // inicial
      const selTipo = document.getElementById('selTipo');
      if (selTipo){
        selTipo.addEventListener('change', ()=>{
          const distrito = document.getElementById('selDistrito').value;
          const bairroSel = document.getElementById('selBairro').value;
          applyOpacityByDomicilios(distrito, bairroSel, selTipo.value);
        });
      }

      document.getElementById('status').textContent = `${Object.keys(setores).length} setores no CSV`;
    }

    
function fillBairros(distrito){
  const selBairro = document.getElementById('selBairro');
  selBairro.innerHTML = '';

  // Sempre adiciona "Todos"
  selBairro.insertAdjacentHTML('beforeend', `<option value="__TODOS__">Todos</option>`);

  // Caso "Todos os distritos": união de todos os bairros
  if (distrito === '__TODOS__'){
    const setAll = new Set();
    Object.values(porDistrito).forEach(obj => {
      if (obj && obj.bairros) for (const b of obj.bairros) setAll.add(b || '(sem bairro)');
    });
    [...setAll]
      .sort((a,b)=>a.localeCompare(b,'pt-BR'))
      .forEach(b=> selBairro.insertAdjacentHTML('beforeend', `<option value="${b}">${b}</option>`));
    return;
  }

  // Caso distrito inválido -> mantém só "Todos"
  if (!distrito || !porDistrito[distrito]) return;

  // Caso distrito específico
  [...porDistrito[distrito].bairros]
    .sort((a,b)=>a.localeCompare(b,'pt-BR'))
    .forEach(b=> selBairro.insertAdjacentHTML('beforeend', `<option value="${b}">${b}</option>`));
}

    function loadCsv(){
      return new Promise(resolve=>{
        Papa.parse(CSV_PATH, {
          header:true, download:true, dynamicTyping:false,
          complete: res => { buildIndex(res.data || []); resolve(); },
          error: () => resolve()
        });
      });
    }

    // ======= CAMADAS =======
    const activeLayers = []; // lista de grupos
    function clearLayers(){
      activeLayers.forEach(g=>{ if (map.hasLayer(g)) map.removeLayer(g); });
      activeLayers.length = 0;
    }

    

function popupHtml(rec){
  let html = `<div><b>Setor ${rec.Cod_setor}</b></div>`;
  html += `<div style="margin:6px 0 8px 0;"><small>${rec.Distrito} — ${rec.Bairro}</small></div>`;
  const skip = new Set(['Cod_setor','Distrito','Bairro']);
  html += `<table class="min">`;
  Object.keys(rec).forEach(k=>{
    if (skip.has(k)) return;
    const label = k.replace(/_/g,' ');
    const norm = String(k).normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim().toLowerCase();
    let v = rec[k];
    if (norm === 'tipo') {
      v = mapTipoValue(v);
    }
    if (v!==undefined && v!=='' && label!=='setor') {
      html += `<tr><td>${label}</td><td style="text-align:right">${v}</td></tr>`;
    }
  });
  html += `</table>`;
  return html;
}


// === Helpers para Tipo e Domicílios ===
function extractTipoCode(v){
  if (v === undefined || v === null) return '';
  const m = String(v).match(/\d+/);
  return m ? m[0] : String(v).trim();
}
function getDomicilios(rec){
  // tenta várias formas: "Domicílios", "Domicilios", "DOMICILIOS"
  const v = rec['Domicílios'] ?? rec['Domicilios'] ?? rec['DOMICILIOS'] ?? rec['domicilios'];
  const n = Number(String(v).replace(/\./g,'').replace(',','.')); // tolera "1.234" ou "1,234"
  return isNaN(n) ? 0 : n;
}

// Registro de camadas por setor para permitir mudar opacidade depois
const sectorLayers = new Map(); // cod -> Array<Layer>

function setSectorOpacity(cod, opacity){
  const arr = sectorLayers.get(cod) || [];
  arr.forEach(lyr=> lyr.setStyle && lyr.setStyle({ fillOpacity: opacity }));
}

function applyOpacityByDomicilios(distrito, bairroSel, tipoCode){
  // Define setores relevantes (do distrito e do bairro escolhido, se houver)
  let setoresDistrito = [];
  if (distrito === '__TODOS__'){
    setoresDistrito = Object.values(porDistrito).flatMap(obj => obj.setores || []);
  } else {
    if (!distrito || !porDistrito[distrito]) return;
    setoresDistrito = porDistrito[distrito].setores;
  }
  if (bairroSel && bairroSel !== '__TODOS__'){
    setoresDistrito = setoresDistrito.filter(c=> (setores[c].Bairro || '') === bairroSel);
  }
  // Se tipo escolhido, filtra "ativos" por tipo
  let ativos = setoresDistrito;
  if (tipoCode){
    ativos = setoresDistrito.filter(c=> extractTipoCode(setores[c]['Tipo']) === String(tipoCode));
  }
  // Calcula min/max de Domicílios nos "ativos"
  const vals = ativos.map(c=> getDomicilios(setores[c])).filter(n=> n>=0);
  const minV = Math.min(...(vals.length?vals:[0]));
  const maxV = Math.max(...(vals.length?vals:[1]));
  // Função de escala para opacidade (0.15 a 0.9)
  const scale = (x)=>{
    if (maxV===minV) return 0.6;
    const t = (x - minV) / (maxV - minV);
    return 0.15 + t * (0.75);
  };
  // Aplica opacidade: setores do tipo selecionado variam por Domicílios; demais ficam baixinhos
  setoresDistrito.forEach(cod=>{
    const rec = setores[cod];
    const matches = !tipoCode || extractTipoCode(rec['Tipo']) === String(tipoCode);
    const op = matches ? scale(getDomicilios(rec)) : 0.05;
    setSectorOpacity(cod, op);
  });
}

    async function refreshLayers(){
      busy(true);
      clearLayers();
      const distrito = document.getElementById('selDistrito').value;
      const bairroSel = document.getElementById('selBairro').value;

      if (!distrito || (distrito !== '__TODOS__' && !porDistrito[distrito])){ const st=document.getElementById('status'); if (st) st.textContent='0 setores exibidos'; busy(false); updateLegend([]); return; }

      const setoresDistrito = (distrito === '__TODOS__') ? Object.values(porDistrito).flatMap(obj => obj.setores || []) : porDistrito[distrito].setores;

      // Definir subconjunto por bairro
      let setoresFiltro = [];
      let colorByBairro = {};
      let bairrosUsados = new Set();

      if (bairroSel === '__TODOS__'){
        // todos os bairros -> cores por bairro
        setoresFiltro = setoresDistrito;
        // coletar bairros presentes e atribuir cores
        bairrosUsados = new Set(setoresFiltro.map(c=> setores[c].Bairro || '(sem bairro)'));
        if (distrito === '__TODOS__'){
          setoresFiltro.forEach(c=>{
            const rec = setores[c];
            const b = rec.Bairro || '(sem bairro)';
            const key = `${rec.Distrito}|${b}`;
            if (!colorByBairro[b]) colorByBairro[b] = colorFor(key);
          });
        } else {
          [...bairrosUsados].forEach(b=> colorByBairro[b] = colorFor(`${distrito}|${b}`));
        }
      } else {
        // bairro específico
        setoresFiltro = setoresDistrito.filter(c=> (setores[c].Bairro || '') === bairroSel);
        const sampleCod = setoresFiltro[0];
        const sampleRec = sampleCod ? setores[sampleCod] : null;
        const color = (distrito === '__TODOS__' && sampleRec) ? colorFor(`${sampleRec.Distrito}|${bairroSel}`) : colorFor(`${distrito}|${bairroSel}`);
        bairrosUsados = new Set([bairroSel]);
        colorByBairro[bairroSel] = color;
      }

      // Atualiza status com a quantidade de setores exibidos
      try{ const st=document.getElementById('status'); if(st) st.textContent=`${setoresFiltro.length} setores exibidos`; }catch(_){}
      // Carregar KMLs dos setores filtrados
      const groups = [];
      for (const cod of setoresFiltro){
        const rec = setores[cod];
        const bairro = rec.Bairro || '(sem bairro)';
        const color = colorByBairro[bairro];
        const filename = filenameFromSetor(cod);
        const tryUrls = [encodeURI(KML_BASE+filename), encodeURI(KML_BASE+`${cod}.kml`)]; // tenta sem sufixo também

        // cria um grupo por setor (para facilitar remoção)
        const group = L.layerGroup();
        groups.push(group);
        activeLayers.push(group);

        // função para carregar com fallback de arquivo
        const loadWithFallback = (i=0)=>{
          if (i>=tryUrls.length){
            console.warn('KML não encontrado para setor', cod);
            return;
          }
          const url = tryUrls[i];
          const k = omnivore.kml(url);
          k.on('ready', ()=>{
            k.eachLayer(lyr=>{
              if (lyr.setStyle){
                lyr.setStyle({ color, weight: 1.1, opacity: 0.9, fillColor: color, fillOpacity: 0.25 });
                const arr = sectorLayers.get(cod) || [];
                arr.push(lyr);
                sectorLayers.set(cod, arr);
              }
              lyr.on('click', (e)=>{
                L.popup().setLatLng(e.latlng).setContent(popupHtml(rec)).openOn(map);
              });
              group.addLayer(lyr);
            });
            map.addLayer(group);
          });
          k.on('error', ()=> loadWithFallback(i+1));
        };
        loadWithFallback();
      }

      // Ajusta legenda (robusto: não quebra se algo faltar)
      try{
        const items = [];
        if (bairrosUsados && bairrosUsados.size){
          bairrosUsados.forEach(lbl=>{
            const cor = (colorByBairro && colorByBairro[lbl]) ? colorByBairro[lbl] : '#888';
            items.push({ label: lbl, color: cor });
          });
        }
        // Se houver função de regiões (limites), agrega itens por regiões selecionadas
        if (typeof buildRegionLegendItems === 'function'){
          const regItems = buildRegionLegendItems() || [];
          regItems.forEach(it=> items.push(it));
        }
        if (typeof updateLegend === 'function') updateLegend(items);
      }catch(_e){ /* silencia erros de legenda */ }

      // Ajusta bounds quando terminar de carregar (tempo pequeno)
      setTimeout(()=>{
        try{
          const all = [];
          activeLayers.forEach(g=> g.eachLayer && g.eachLayer(l=> all.push(l)));
          if (all.length){
            const fg = L.featureGroup(all);
            map.fitBounds(fg.getBounds(), {padding:[20,20]});
          }
        }catch(e){}

        const selTipo = document.getElementById('selTipo');
        applyOpacityByDomicilios(distrito, bairroSel, selTipo ? selTipo.value : '');
        try{ const st=document.getElementById('status'); if(st) st.textContent=`${setoresFiltro.length} setores exibidos`; }catch(_){}
        busy(false);
      }, 800);
    }

    function updateLegend(items){
      const wrap = document.getElementById('legend');
      const list = document.getElementById('legendItems');
      if (!items || items.length===0){ wrap.style.display='none'; list.innerHTML=''; return; }
      wrap.style.display = 'block';
      list.innerHTML = items.map(it=>`<div class="row"><span class="sw" style="background:${it.color}"></span><span>${it.label}</span></div>`).join('');
    }


// ====== Regiões (KML) via combobox ======
const REGIONS_KML = [
  { id: 'barcarena',   name: 'Barcarena (Sede)', file: 'distritos/kml/barcarena_dissolved_lines.kml',   color: '#7c3aed' },
  { id: 'murucupi',    name: 'Murucupi',         file: 'distritos/kml/murucupi_dissolved_lines.kml',    color: '#f59e0b' },
  { id: 'estradas',    name: 'Estradas',         file: 'distritos/kml/estradas_dissolved_lines.kml',    color: '#2563eb' },
  { id: 'ilhas',       name: 'Ilhas',            file: 'distritos/kml/ilhas_dissolved_lines.kml',       color: '#10b981' },
  { id: 'viladoconde', name: 'Vila do Conde',    file: 'distritos/kml/viladoconde_dissolved_lines.kml', color: '#ef4444' },
];
const regionKmlLayers = new Map(); // id -> L.GeoJSON

function dashedStyle(color){
  return { color, weight: 3, opacity: 0.95, dashArray: '6 6', fillOpacity: 0 };
}
function addRegionLayer(r){
  if (regionKmlLayers.has(r.id)){
    const layer = regionKmlLayers.get(r.id);
    if (!map.hasLayer(layer)) layer.addTo(map);
    return layer;
  }
  const layer = omnivore.kml(r.file, null, L.geoJSON(null, { style: dashedStyle(r.color) }));
  layer.addTo(map);
  regionKmlLayers.set(r.id, layer);
  return layer;
}
function removeAllRegionLayers(){
  for (const [,layer] of regionKmlLayers){
    if (map.hasLayer(layer)) map.removeLayer(layer);
  }
}
function loadRegionsFromSelect(){
  const sel = document.getElementById('selKmlRegion');
  const v = sel.value;
  removeAllRegionLayers();
  let toFit = [];
  if (v === '__ALL__'){
    REGIONS_KML.forEach(r => {
      const layer = addRegionLayer(r);
      toFit.push(layer);
    });
  } else {
    const r = REGIONS_KML.find(x => x.id === v);
    if (r){
      const layer = addRegionLayer(r);
      toFit.push(layer);
    }
  }
  // Fit bounds to loaded KMLs (if any)
  setTimeout(() => {
    try{
      const layers = [];
      toFit.forEach(l => l && l.eachLayer && l.eachLayer(x => layers.push(x)));
      if (layers.length){
        const fg = L.featureGroup(layers);
        const b = fg.getBounds();
        if (b.isValid()) map.fitBounds(b.pad(0.08));
      }
    }catch(e){ /* noop */ }
  }, 300);
}

// Initialize KML combo after DOM is ready
(function setupKmlCombo(){
  const sel = document.getElementById('selKmlRegion');
  if (!sel) return;
  sel.addEventListener('change', loadRegionsFromSelect);
  // Default to "Todos" at load
  sel.value = '__ALL__';
  loadRegionsFromSelect();
})();

    (async function init(){
      await loadCsv();
      // opcional: selecione automaticamente o primeiro distrito
      const selDistrito = document.getElementById('selDistrito');
      if (selDistrito.options.length>0){
        selDistrito.value = '__TODOS__';
        fillBairros(selDistrito.value);
        refreshLayers();
      }
    })();
  </script>

<script>



function mapTipoValue(v){
  if (v === undefined || v === null) return '';
  let raw = String(v).trim();
  const m = raw.match(/\d+/);
  const code = m ? m[0] : raw;
  const dict = {
    '1': 'Área urbana de alta densidade de edificações de cidade ou vila',
    '2': 'Área urbana de baixa densidade de edificações de cidade ou vila',
    '3': 'Núcleo urbano',
    '5': 'Aglomerado rural - Povoado',
    '6': 'Aglomerado rural - Núcleo rural',
    '7': 'Aglomerado rural - Lugarejo',
    '8': 'Área rural (exclusive aglomerados)',
    '9': 'Massas de água'
  };
  return dict[code] ? dict[code] : raw;
}

</script>

</body>
</html>
